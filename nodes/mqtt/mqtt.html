<!-- connio -->
<script type="text/javascript">
  window.connio = {};
</script>

<!-- constants -->
<script type="text/javascript">
  const ElementId = {
    AUTH: makeId('node-input-auth'),

    ACCOUNT: makeId('node-input-account'),

    CLIENT_ID: makeId('node-input-clientId'),
    API_KEY_ID: makeId('node-input-apiKeyId'),
    API_KEY_SECRET: makeId('node-input-apiKeySecret'),

    APP: makeId('node-input-app'),

    TOPIC_PREFIX: makeId('topicPrefix'),
    TOPIC_VALUE: makeId('node-input-topicValue'),
  };

  const PropertyState = {
    SELECTED: ['selected', true],
    DISABLED: ['disabled', true],
    ENABLED: ['disabled', false],
  };

  const EventType = {
    CLICK: 'click',
    CHANGE: 'change',
  };

  function makeId(name) {
    return `#${name}`;
  }

  Object.assign(window.connio, {
    ElementId,
    PropertyState,
    EventType,
  });
</script>

<!-- ConnioAPI -->
<script type="text/javascript">
  class ConnioAPI {
    authNodeId = undefined;
    credentials = {
      username: undefined,
      password: undefined,
    };
    apiKey = {
      id: undefined,
      secret: undefined,
    };

    constructor({ $, authNodeId, username, password, url: authUrl, apiUrl }) {
      Object.assign(this, {
        $,
        authUrl,
        apiUrl,
        headers: {
          'connio-auth-url': authUrl,
          'connio-api-url': apiUrl,
        },
      });

      if (username && password) {
        Object.assign(this, {
          credentials: {
            username,
            password,
          },
          headers: {
            ...this.headers,
            'connio-username': username,
            'connio-password': password,
          },
        });
      } else {
        Object.assign(this, {
          authNodeId,
          headers: {
            ...this.headers,
            'auth-node-id': authNodeId,
          },
        });
      }
    }

    _get(url) {
      return this.$.ajax({
        url,
        json: true,
        headers: this.headers,
      });
    }

    login() {
      return this._get('login')
        .done((response) => {
          Object.assign(this, {
            accountId: response.user.accountId,
            apiKey: {
              username: response.apiKey.id,
              password: response.apiKey.secret,
            },
            headers: {
              ...this.headers,
              'connio-key-id': response.apiKey.id,
              'connio-key-secret': response.apiKey.secret,
            },
          });

          return response;
        })
        .fail((error) => {
          return error;
        });
    }

    fetchAccount() {
      return this._get(`accounts?id=${this.accountId}`);
    }

    fetchApiClients() {
      return this._get('api-clients');
    }

    fetchApiKey(clientId) {
      return this._get(`api-key?clientId=${clientId}`);
    }

    fetchApp(id) {
      return this._get(`app?id=${id}`);
    }

    fetchApps(appIdList = []) {
      return new Promise((resolve, reject) => {
        const requests = Promise.all(appIdList.map((id) => this.fetchApp(id)));

        return requests.then(resolve);
      });
    }
  }

  Object.assign(window.connio, {
    ConnioAPI,
  });
</script>

<!-- Topic -->
<script type="text/javascript">
  class Topic {
    static ACCOUNT_PLACEHOLDER = '{account}';
    static APP_PLACEHOLDER = '{app}';
    static DEFAULT_VALUE = '#';

    static _getNodeValue(node) {
      return node.val();
    }

    static parse(topicNode) {
      const [
        accountName,
        app,
        appName,
        devices,
        ...topicValue
      ] = this._getNodeValue(topicNode).split('/');

      return [
        `${accountName}/${app}/${appName}/${devices}/`,
        topicValue.join('/'),
      ];
    }

    static build(prefixNode, valueNode) {
      const prefix = this._getNodeValue(prefixNode);
      const value = this._getNodeValue(valueNode);

      return `${prefix}${value}`;
    }

    static buildPrefix(account, app) {
      return [
        account || this.ACCOUNT_PLACEHOLDER,
        'apps',
        app || this.APP_PLACEHOLDER,
        'devices',
        '',
      ]
        .join('/')
        .toLowerCase();
    }

    static buildValue(value) {
      return value || this.DEFAULT_VALUE;
    }
  }

  Object.assign(window.connio, {
    Topic,
  });
</script>

<!-- connio-mqtt node -->
<script type="text/javascript">
  const {
    ConnioAPI,
    ElementId,
    EventType,
    PropertyState,
    Topic,
  } = window.connio;

  const NODE_ID = 'connio-mqtt';
  const DEFAULT_NAME = 'Connio MQTT';

  function makeOption(value, label, selected = false) {
    return $('<option></option>')
      .val(value)
      .text(label)
      .prop('selected', selected);
  }

  function makeDefaultOption(label) {
    return makeOption('', label)
      .prop(...PropertyState.SELECTED)
      .prop(...PropertyState.DISABLED);
  }

  function makeSyncValue(_this) {
    return function(node, valueName, value) {
      node.val(value);
      _this.state[valueName] = node.val();
    };
  }

  function handleConfigUpdate(payload) {
    try {
      let { email, credentials, connioConfig } = RED.nodes.node(this.auth);

      if (!connioConfig) {
        return;
      }

      let { url, apiUrl } = payload;

      if (!url || !apiUrl) {
        return;
      }

      connioApi = new ConnioAPI({
        $,
        url,
        apiUrl,
        username: email,
        password: credentials && credentials.password,
        authNodeId: this.auth,
      });

      this.isConfigUpdated = true;
    } catch (error) {
      console.error(error);
    }
  }

  function handleCredentialsUpdate(payload) {
    try {
      let { email, credentials, connioConfig } = payload;

      if (!connioConfig) {
        return;
      }

      let { url, apiUrl } = RED.nodes.node(connioConfig);

      if (!url || !apiUrl) {
        return;
      }

      connioApi = new ConnioAPI({
        $,
        url,
        apiUrl,
        username: email,
        password: credentials && credentials.password,
        authNodeId: this.auth,
      });

      this.isCredentialsUpdated = true;
    } catch (error) {
      console.error(error);
    }
  }

  let MqttNode = {
    category: 'input',
    color: '#a6bbcf',
    defaults: {
      auth: {
        type: 'connio-credentials',
      },
      name: {
        value: DEFAULT_NAME,
      },
      account: {
        required: true,
      },
      clientId: {
        required: true,
      },
      apiKeyId: {
        required: true,
      },
      apiKeySecret: {
        required: true,
      },
      app: {
        required: true,
      },
      topicValue: {
        value: '#',
        required: true,
      },
    },
    inputs: 0,
    outputs: 1,
    icon: 'connio.png',
    label() {
      return this.name || DEFAULT_NAME;
    },
    oneditprepare() {
      let connioApi;
      let syncValue = makeSyncValue(this);
      let isFirstAuthChange = true;

      let $auth = $(ElementId.AUTH);
      let $account = $(ElementId.ACCOUNT);

      let $clientId = $(ElementId.CLIENT_ID);
      let $apiKeyId = $(ElementId.API_KEY_ID);
      let $apiKeySecret = $(ElementId.API_KEY_SECRET);

      let $app = $(ElementId.APP);

      let $topicPrefix = $(ElementId.TOPIC_PREFIX);
      let $topicValue = $(ElementId.TOPIC_VALUE);

      let makeApiClientSelector = (apiClientList = []) => {
        if (!apiClientList.length) {
          return $clientId
            .prop(...PropertyState.DISABLED)
            .empty()
            .append(
              makeDefaultOption(
                this._('api-field.empty', {
                  entity: this._('glossary.api-client'),
                }),
              ),
            );
        }

        $clientId
          .empty()
          .append([
            makeDefaultOption(this._('api-client-field.placeholder')),
            ...apiClientList.map((item) =>
              makeOption(
                item.id,
                item.friendlyName || item.name,
                this.state.clientId === item.id,
              ),
            ),
          ])
          .prop(...PropertyState.ENABLED);
      };

      let makeAppSelector = (appList = []) => {
        if (!appList.length) {
          return $app
            .prop(...PropertyState.DISABLED)
            .empty()
            .append(
              makeDefaultOption(
                this._('app-field.empty', {
                  entity: this._('glossary.app'),
                }),
              ),
            );
        }

        return $app
          .empty()
          .append([
            makeDefaultOption(this._('app-field.placeholder')),
            ...appList.map((item) =>
              makeOption(
                item.name,
                item.friendlyName || item.name,
                this.state.app === item.name,
              ),
            ),
          ])
          .prop(...PropertyState.ENABLED);
      };

      let authChangeHandler = () => {
        let nextAuth = $auth.val();

        if (nextAuth === '_ADD_') {
          syncValue($auth, 'auth', nextAuth);
          emptyAuthSelectionFlow();

          return;
        }

        if (
          this.state.auth === nextAuth &&
          !isFirstAuthChange &&
          !this.isConfigUpdated &&
          !this.isCredentialsUpdated
        ) {
          return;
        }

        syncValue($auth, 'auth', nextAuth);

        let { email, credentials, connioConfig } = RED.nodes.node(nextAuth);

        if (!connioConfig) {
          return;
        }

        let { url, apiUrl } = RED.nodes.node(connioConfig);

        if (!url || !apiUrl) {
          return;
        }

        connioApi = new ConnioAPI({
          $,
          url,
          apiUrl,
          username: email,
          password: credentials && credentials.password,
          authNodeId: this.state.auth,
        });

        if (
          isFirstAuthChange ||
          this.isConfigUpdated ||
          this.isCredentialsUpdated
        ) {
          isFirstAuthChange = false;
          this.isConfigUpdated = false;
          this.isCredentialsUpdated = false;

          loadingFlow();
        } else {
          authSelectionFlow();
        }
      };

      let clientIdChangeHandler = () => {
        let nextClientTd = $clientId.val();

        if (!nextClientTd) {
          return;
        }

        if (nextClientTd === this.state.clientId) {
          return;
        }

        syncValue($clientId, 'clientId', nextClientTd);

        apiClientSelectionFlow();
      };

      let appChangeHandler = () => {
        let nextApp = $app.val();

        if (!nextApp) {
          return;
        }

        if (nextApp === this.state.app) {
          return;
        }

        syncValue($app, 'app', nextApp);
        syncValue(
          $topicPrefix,
          'topicPrefix',
          Topic.buildPrefix(this.state.account, this.state.app),
        );
      };

      /**
       * @description
       * …
       */
      let emptyAuthSelectionFlow = () => {
        $account.prop(...PropertyState.DISABLED);
        $clientId.prop(...PropertyState.DISABLED);
        $app.prop(...PropertyState.DISABLED);
        $topicValue.prop(...PropertyState.DISABLED);

        syncValue($account, 'account', '');
        syncValue($clientId, 'clientId', '');
        syncValue($apiKeyId, 'apiKeyId', '');
        syncValue($apiKeySecret, 'apiKeySecret', '');
        syncValue($app, 'app', '');
        syncValue($topicPrefix, 'topicPrefix', Topic.buildPrefix());
        syncValue($topicValue, 'topicValue', Topic.DEFAULT_VALUE);
      };

      /**
       * @todo Make sure that fail fall through to the latests handler
       * @description
       * set "$account" to "Disabled" state
       * set "$clientId" to "Disabled" state
       * set "$app" to "Disabled" state
       * set "$topicValue" to "Disabled" state
       *
       * connioApi.login
       *  => SUCCESS
       *  => ERROR
       * …
       */
      let loadingFlow = () => {
        $auth.prop(...PropertyState.DISABLED);

        $account.prop(...PropertyState.DISABLED);
        syncValue($account, 'account', this._('common.loading'));

        $clientId
          .prop(...PropertyState.DISABLED)
          .empty()
          .append(makeDefaultOption(this._('api-client-field.placeholder')));

        $app
          .prop(...PropertyState.DISABLED)
          .empty()
          .append(makeDefaultOption(this._('app-field.placeholder')));

        $topicValue.prop(...PropertyState.DISABLED);

        connioApi
          .login()
          .then(() => {
            connioApi.fetchAccount().then((account) => {
              syncValue($account, 'account', account.name);

              syncValue(
                $topicPrefix,
                'topicPrefix',
                Topic.buildPrefix(account.name, this.state.app),
              );
              syncValue(
                $topicValue,
                'topicValue',
                Topic.buildValue(this.state.topicValue),
              );

              $topicValue.prop(...PropertyState.ENABLED);

              $clientId
                .prop(...PropertyState.DISABLED)
                .empty()
                .append(makeDefaultOption(this._('common.loading')));

              connioApi.fetchApiClients().then((apiClientList) => {
                makeApiClientSelector(apiClientList);

                if (this.state.clientId) {
                  $auth.prop(...PropertyState.DISABLED);
                  $clientId.prop(...PropertyState.DISABLED);

                  $app
                    .prop(...PropertyState.DISABLED)
                    .empty()
                    .append(makeDefaultOption(this._('common.loading')));

                  return connioApi
                    .fetchApiKey(this.state.clientId)
                    .then(({ appList: appIdList }) => {
                      connioApi.fetchApps(appIdList).then((appList) => {
                        $auth.prop(...PropertyState.ENABLED);
                        $clientId.prop(...PropertyState.ENABLED);

                        makeAppSelector(appList);
                      });
                    });
                }

                $auth.prop(...PropertyState.ENABLED);
              });
            });
          })
          .fail((error) => {
            $auth.prop(...PropertyState.ENABLED);

            syncValue($account, 'account', this._('error.unknown'));

            RED.notify(
              `
                <b>Connio</b>
                <br>

                <i>${error.responseJSON[0].cause}</i>
                <br><br>

                ${error.responseJSON[0].message}
              `,
              'error',
            );
          });
      };

      /**
       * @description
       * reset "account"
       * reset "clientId"
       * reset "apiKeyId"
       * reset "apiKeySecret"
       * reset "app"
       * reset "topicPrefix" to account only
       * reset "topicValue" to '#' (all)
       *
       * set "auth" selector to "Disabled"
       * set "account" to "Loading"
       * set "clientId" selector to "Initial (Disabled)" state
       * set "app" selector to "Initial" state
       * ↓
       * fetchAccount
       *   => SUCCESS =>
       *   ↓
       *     => set "account" field
       *     => set "topicPrefix" field to "account"
       *     => set "clientId" selector to "Loading (Disabled)" state
       *     => fetchApiClients
       *       => SUCCESS
       *       ↓
       *         => create "clientId" selector
       *         => set "auth" selector to "Enabled"
       *       => ERROR => ?
       *   => ERROR => ?
       */
      let authSelectionFlow = () => {
        syncValue($account, 'account', '');
        syncValue($clientId, 'clientId', '');
        syncValue($apiKeyId, 'apiKeyId', '');
        syncValue($apiKeySecret, 'apiKeySecret', '');
        syncValue($app, 'app', '');

        syncValue(
          $topicPrefix,
          'topicPrefix',
          Topic.buildPrefix(this.state.account),
        );
        syncValue($topicValue, 'topicValue', Topic.DEFAULT_VALUE);

        $auth.prop(...PropertyState.DISABLED);

        $account.val(this._('common.loading'));

        $clientId
          .prop(...PropertyState.DISABLED)
          .empty()
          .append(makeDefaultOption(this._('api-client-field.placeholder')));

        $app
          .prop(...PropertyState.DISABLED)
          .empty()
          .append(makeDefaultOption(this._('app-field.placeholder')));

        connioApi
          .login()
          .then(() => {
            connioApi.fetchAccount().then((account) => {
              syncValue($account, 'account', account.name);
              syncValue(
                $topicPrefix,
                'topicPrefix',
                Topic.buildPrefix(this.state.account),
              );
            });

            $clientId
              .prop(...PropertyState.DISABLED)
              .empty()
              .append(makeDefaultOption(this._('common.loading')));

            connioApi.fetchApiClients().then((apiClientList) => {
              makeApiClientSelector(apiClientList);

              $auth.prop(...PropertyState.ENABLED);
            });
          })
          .fail(() => {
            $auth.prop(...PropertyState.ENABLED);

            syncValue($account, 'account', this._('error.auth'));
          });
      };

      /**
       * @description
       * reset "apiKeyId"
       * reset "apiKeySecret"
       * reset "app"
       * reset "topicPrefix" to account only
       * reset "topicValue" to '#' (all)
       *
       * set "auth" to "Disabled" state
       * set "clientId" to "Disabled" state
       * set "app" selector to "Loading (Disabled)" state
       * ↓
       * fetch ApiKey
       *   => SUCCESS =>
       *   ↓
       *     set "apiKeyId" value
       *     set "apiKeySecret" value
       *
       *     fetch apps
       *       => SUCCESS =>
       *       ↓
       *         create "app" selector
       *         set "auth" to "Disabled" state
       *         set "clientId" selector to "Enabled" state
       *       => ERROR => ?
       *   => ERROR => ?
       */
      let apiClientSelectionFlow = () => {
        syncValue($apiKeyId, 'apiKeyId', '');
        syncValue($apiKeySecret, 'apiKeySecret', '');
        syncValue($app, 'app', '');

        syncValue(
          $topicPrefix,
          'topicPrefix',
          Topic.buildPrefix(this.state.account),
        );
        syncValue($topicValue, 'topicValue', Topic.DEFAULT_VALUE);

        $auth.prop(...PropertyState.DISABLED);
        $clientId.prop(...PropertyState.DISABLED);

        $app
          .prop(...PropertyState.DISABLED)
          .empty()
          .append(makeDefaultOption(this._('common.loading')));

        connioApi
          .fetchApiKey(this.state.clientId)
          .then(({ id, secret, appList: appIdList }) => {
            syncValue($apiKeyId, 'apiKeyId', id);
            syncValue($apiKeySecret, 'apiKeySecret', secret);

            return connioApi.fetchApps(appIdList).then((appList) => {
              makeAppSelector(appList);

              $auth.prop(...PropertyState.ENABLED);
              $clientId.prop(...PropertyState.ENABLED);
            });
          });
      };

      /**
       * @description
       * …
       */
      let init = () => {
        let state = {
          account: this.account,
          apiKeyId: this.apiKeyId,
          apiKeySecret: this.apiKeySecret,
          app: this.app,
          auth: this.auth,
          clientId: this.clientId,
          topicValue: this.topicValue,
        };

        Object.assign(this, {
          state,
          backup: {
            ...state,
          },
        });

        this.handleCredentialsUpdate = handleCredentialsUpdate.bind(this);
        this.handleConfigUpdate = handleConfigUpdate.bind(this);

        RED.events.on('@credentials/update', this.handleCredentialsUpdate);
        RED.events.on('@config/update', this.handleConfigUpdate);

        /** @event $auth change */
        $auth.on(EventType.CHANGE, authChangeHandler.bind(this));

        /** @event $clientId change */
        $clientId.on(EventType.CHANGE, clientIdChangeHandler.bind(this));

        /** @event $app change */
        $app.on(EventType.CHANGE, appChangeHandler.bind(this));
      };

      init();
    },
    oneditcancel() {
      RED.events.off('@credentials/update', this.handleCredentialsUpdate);
      RED.events.off('@config/update', this.handleConfigUpdate);

      Object.assign(this, {
        ...this.backup,
      });
    },
    oneditsave() {
      RED.events.off('@credentials/update', this.handleCredentialsUpdate);
      RED.events.off('@config/update', this.handleConfigUpdate);

      if (!this.topicValue) {
        makeSyncValue(this)(
          $('#node-input-topicValue'),
          'topicValue',
          Topic.buildValue(),
        );
      }
    },
  };

  RED.nodes.registerType(NODE_ID, MqttNode);
</script>

<script type="text/x-red" data-template-name="connio-mqtt">
  <div class="form-row">
    <label for="node-input-auth" data-i18n="credentials-field.label"></label>

    <input type="text" id="node-input-auth" data-i18n="[placeholder]credentials-field.placeholder">
  </div>

  <div id="logged-in-section">
    <div class="form-row">
      <label for="node-input-account" data-i18n="account-field.label"></label>

      <input type="text" id="node-input-account" readonly>
    </div>

    <div class="form-row">
      <label for="node-input-clientId" data-i18n="api-client-field.label"></label>

      <select id="node-input-clientId">
        <option value="" selected disabled data-i18n="api-client-field.placeholder"></option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-app" data-i18n="app-field.label"></label>

      <select id="node-input-app" disabled>
        <option value="" selected disabled data-i18n="app-field.placeholder"></option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-topicValue" data-i18n="topic-field.label"></label>
      <br>

      <div style="display: flex">
        <input
          type="text"
          id="topicPrefix"
          style="
            width: auto;

            flex-grow: 4;

            border-top-right-radius: 0;
            border-right: 0;
            border-bottom-right-radius: 0;
          "
          readonly
        >

        <input
          type="text"
          id="node-input-topicValue"
          style="
            width: auto;

            flex-grow: 3;

            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
          "
        >
      </div>
    </div>

    <hr>

    <div class="form-row">
      <label
        for="node-input-name"
        data-i18n="name-field.label"
      ></label>

      <input type="text" id="node-input-name" data-i18n="[placeholder]name-field.placeholder">
    </div>
  </div>

  <input type="hidden" id="node-input-apiKeyId">
  <input type="hidden" id="node-input-apiKeySecret">
</script>
